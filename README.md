
Rabbit Logger Service
=====================

Rabbit Logger Service ‚Äî —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. 
–û–Ω –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å ClickHouse –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, RabbitMQ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 
–ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Metabase –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫.

–û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
----------------
- RabbitMQ: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏ `logs` –∏ `apm`, –ø—Ä–∏–Ω–∏–º–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞—è –∏—Ö –≤ ClickHouse.
- ClickHouse: –ë—ã—Å—Ç—Ä–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫.
- Metabase: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫–∏—Ö –∫–∞–∫ –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω–æ –≤–∞—à–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º).

–ó–∞–ø—É—Å–∫ —Å –ø–æ–º–æ—â—å—é Docker Compose
-------------------------------
–ü—Ä–∏–º–µ—Ä `docker-compose.yml` –ø—Ä–∏–≤–µ–¥–µ–Ω –Ω–∏–∂–µ:

```
version: "3.8"

services:
  rabbit-logger:
    build: .
    ports:
      - "8123:8123"     # ClickHouse HTTP-interface
      - "9000:9000"     # ClickHouse TCP-interface
      - "5672:5672"     # RabbitMQ AMQP
      - "9999:9999/udp" # UDP
    environment:
      - CLICKHOUSE_USER=clickhouse-user
      - CLICKHOUSE_PASSWORD=secret-password
      - LOG_RETENTION_DAYS=30
      - APM_RETENTION_DAYS=30
    volumes:
      - clickhouse_data:/var/lib/clickhouse

volumes:
  clickhouse_data:
```

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
---------------------
### Rabbit-logger
- CLICKHOUSE_USER: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è ClickHouse.
- CLICKHOUSE_PASSWORD: –ü–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ClickHouse.
- LOG_RETENTION_DAYS: –ß–∏—Å–ª–æ –¥–Ω–µ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30).
- APM_RETENTION_DAYS: –ß–∏—Å–ª–æ –¥–Ω–µ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30).

–¢–∞–∫–∂–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–∏—Ö –ª–æ–≥–æ–≤ –∏ apm, –¥–æ–±–∞–≤–∏–≤ –≤ docker-compose.yml:
---------------------
```
  db:
    image: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=postgres
      - POSTGRES_USER=debug
      - POSTGRES_PASSWORD=debug
    ports:
      - "5434:5432"

  metabase:
    image: metabase/metabase:latest
    restart: always
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=postgres
      - MB_DB_PORT=5432
      - MB_DB_USER=debug
      - MB_DB_PASS=debug
      - MB_DB_HOST=db
    volumes:
      - ./clickhouse.metabase-driver.jar:/plugins/clickhouse.metabase-driver.jar
    ports:
      - 3000:3000
    depends_on:
      - db

volumes:
  postgres_data:
```
---------------------

### PostgreSQL (–¥–ª—è Metabase)
- POSTGRES_HOST: –•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL.
- POSTGRES_PORT: –ü–æ—Ä—Ç PostgreSQL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5432).
- POSTGRES_DB: –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- POSTGRES_USER: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- POSTGRES_PASSWORD: –ü–∞—Ä–æ–ª—å –¥–ª—è PostgreSQL.

### Metabase
- MB_DB_TYPE: –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Metabase (PostgreSQL).
- MB_DB_DBNAME: –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Metabase.
- MB_DB_PORT: –ü–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Metabase.
- MB_DB_USER: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è Metabase.
- MB_DB_PASS: –ü–∞—Ä–æ–ª—å –¥–ª—è Metabase.
- MB_DB_HOST: –•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Metabase.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
-------------
1. –ó–∞–ø—É—Å–∫ Rabbit Logger:
   ```bash
   docker-compose up -d
   ```

2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Metabase:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Metabase —á–µ—Ä–µ–∑ `http://localhost:3000`.
   - –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–∞–∑—É ClickHouse (—É–∫–∞–∂–∏—Ç–µ HTTP-–ø–æ—Ä—Ç ClickHouse: `8123`, host: `rabbit-logger`, –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∫–∞–∑–∞–ª–∏ –≤ ClickHouse environment).

3. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤:
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Metabase –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ClickHouse. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å–≤–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, –µ—Å–ª–∏ Metabase –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.

4. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
   –õ–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `LOG_RETENTION_DAYS=30`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ cron-–∑–∞–¥–∞–Ω–∏—è.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤–æ–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
--------------------------
–ï—Å–ª–∏ –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ Metabase:
- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ ClickHouse —á–µ—Ä–µ–∑ –µ–≥–æ HTTP- –∏–ª–∏ TCP-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API ClickHouse –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä SQL-–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 –∑–∞–ø–∏—Å–µ–π –∏–∑ –ª–æ–≥–æ–≤:
```sql
SELECT * 
FROM rabbit_logger.logs
ORDER BY created_dt DESC
LIMIT 100;
```

–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
-----------------
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
  ```bash
  docker-compose ps
  ```

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
  ```bash
  docker logs <container_name>
  ```

–°–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ